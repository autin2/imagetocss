<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Image → CSS</title>
  <link rel="stylesheet" href="style.css"/>
  <meta name="theme-color" content="#0f172a"/>

  <style>
    body.is-app { overflow:auto; }
    .wrap { max-width: 1200px; margin: 28px auto; padding: 0 18px; }

    .two { display:grid; grid-template-columns: 1.05fr .95fr; gap: 18px; align-items:start; }
    @media (max-width: 980px){ .two { grid-template-columns: 1fr; } }

    .panel { background: var(--paper); border:1px solid var(--border); border-radius: var(--radius); box-shadow: var(--shadow); }
    .panel.pad { padding: 16px; }
    .h { font-weight:800; padding: 12px 14px; border-bottom:1px solid var(--border); }

    .drop {
      position: relative; border: 2px dashed var(--border); border-radius: 12px; background: #fff;
      min-height: 260px; display:grid; place-items:center; text-align:center;
      transition: background .2s ease, border-color .2s ease, min-height .2s ease;
    }
    .drop.drag { border-color: var(--accent); background: #f0fbff; }
    .drop img.preview { max-width: 100%; max-height: 100%; border-radius: 10px; display: none; }
    .drop .empty { color: var(--muted); }
    .drop .btnrow { margin-top: 10px; display:flex; gap:10px; justify-content:center; }

    .drop.has-img img.preview { display: block; }
    .drop.has-img .empty { display: none; }
    .drop.has-img { min-height: auto; }

    .change-overlay { position:absolute; inset:0; display:none; background: rgba(15,23,42,.22); border-radius: 10px; align-items:center; justify-content:center; }
    .drop.has-img:hover .change-overlay { display:flex; }
    .change-overlay .btn { background: #fff; }

    .formgrid { display:grid; grid-template-columns: 1fr auto; gap:12px; align-items:end; margin-top:12px; }
    @media (max-width: 720px){ .formgrid { grid-template-columns: 1fr; } }

    .input { width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:10px; background:#fff; outline:none; }
    .label { font-size:13px; color:var(--muted); margin-bottom:6px; font-weight:700; display:block; }

    .codebox { position:relative; }
    .codebox .copy { position:absolute; top:10px; right:10px; }
    .code { height: 360px; white-space: pre; tab-size: 2; }

    .loading { position: fixed; inset: 0; background: rgba(255,255,255,.6); display: none; z-index: 50; align-items:center; justify-content:center; backdrop-filter: blur(2px); }
    .loading.on { display: flex; }
    .spinner { width: 42px; height: 42px; border: 4px solid #c7d2fe; border-top-color: var(--accent); border-radius: 50%; animation: spin 0.9s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    .pill { background:#eef2ff; color:#312e81; padding:6px 10px; border-radius:999px; font-weight:700; font-size:12px; }
  </style>
</head>
<body class="is-app">
  <!-- Header (same pattern as index: click name = sign out) -->
  <header class="header">
    <div class="container nav">
      <a href="/" class="brand">
        <span class="brand-mark" aria-hidden="true"></span>
        <b>Image&nbsp;to&nbsp;CSS</b>
      </a>
      <nav class="links" aria-label="Primary">
        <div class="nav-center">
          <a href="pricing.html">Pricing</a>
          <a href="app.html" class="btn small primary" aria-current="page">Try it out</a>
        </div>
        <div class="nav-auth">
          <button class="btn small ghost js-open-auth" type="button">Sign in</button>
        </div>
      </nav>
    </div>
  </header>

  <main class="wrap">
    <h1 style="margin:0 0 8px">Image → CSS</h1>
    <p class="lead">Upload/paste a <b>cropped screenshot of one component</b> (button, card, input). We’ll generate scoped CSS and a matching HTML snippet.</p>

    <div class="two">
      <!-- LEFT -->
      <section class="panel pad" style="align-self:start">
        <div class="drop" id="drop">
          <img id="preview" class="preview" alt="preview"/>
          <div class="change-overlay"><button class="btn">Change photo</button></div>

          <div class="empty">
            <div class="label" style="font-size:14px;font-weight:800;color:var(--ink)">Drop an image, click <i>Choose</i>, or paste (Ctrl/Cmd+V).</div>
            <div class="btnrow">
              <button id="choose" class="btn">Choose</button>
              <button id="pasteBtn" class="btn">Paste</button>
              <input id="file" type="file" accept="image/*" hidden />
            </div>
            <div id="imgStatus" class="hint" style="margin-top:8px">No image selected</div>
          </div>
        </div>

        <div class="formgrid">
          <div>
            <label class="label" for="scope">Scope class</label>
            <input id="scope" class="input" value=".comp" spellcheck="false"/>
          </div>

          <div style="display:flex; gap:10px;">
            <button id="go" class="btn primary">Generate CSS</button>
            <button id="clear" class="btn">Clear</button>
          </div>
        </div>

        <div style="margin-top:10px; display:flex; align-items:center; gap:10px;">
          <span class="label" style="margin:0">API:</span>
          <span id="apiStatus" class="pill">—</span>
        </div>
      </section>

      <!-- RIGHT -->
      <section class="panel pad">
        <div class="codebox">
          <div class="h">Final CSS</div>
          <button id="copyCss" class="btn small copy">Copy</button>
          <pre id="outputCss" class="code"></pre>
        </div>

        <div class="codebox" style="margin-top:14px">
          <div class="h">HTML DIV</div>
          <button id="copyHtml" class="btn small copy">Copy</button>
          <pre id="outputHtml" class="code"></pre>
        </div>
      </section>
    </div>
  </main>

  <div id="loading" class="loading"><div class="spinner" aria-label="Loading"></div></div>

  <!-- Supabase auth state for header; click name => signOut -->
  <script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
  <script>
    const SUPABASE_URL = "https://vsdmfjkhehtagsrvxbav.supabase.co";
    const SUPABASE_ANON_KEY = "YOUR_PUBLIC_ANON_KEY_HERE";
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: { persistSession: true, autoRefreshToken: true }
    });

    const authSlot = document.querySelector('.nav-auth');
    function setSignedInUI(user) {
      authSlot.replaceChildren();
      if (user) {
        const btn = document.createElement('button');
        btn.className = 'btn small ghost';
        btn.textContent = user.user_metadata?.name || user.email || 'Account';
        btn.title = 'Click to sign out';
        btn.onclick = () => supabaseClient.auth.signOut();
        authSlot.appendChild(btn);
      } else {
        const b = document.createElement('button');
        b.type = 'button';
        b.className = 'btn small ghost js-open-auth';
        b.textContent = 'Sign in';
        b.onclick = () => alert('Open your auth modal here if needed.');
        authSlot.appendChild(b);
      }
    }
    (async () => {
      const { data: { session } } = await supabaseClient.auth.getSession();
      setSignedInUI(session?.user || null);
    })();
    supabaseClient.auth.onAuthStateChange((_e, s) => setSignedInUI(s?.user||null));
  </script>

  <script>
    const drop = document.getElementById('drop');
    const fileInput = document.getElementById('file');
    const chooseBtn = document.getElementById('choose');
    const pasteBtn = document.getElementById('pasteBtn');
    const preview = document.getElementById('preview');
    const imgStatus = document.getElementById('imgStatus');

    const scopeEl = document.getElementById('scope');
    const goBtn = document.getElementById('go');
    const clearBtn = document.getElementById('clear');

    const outCss = document.getElementById('outputCss');
    const outHtml = document.getElementById('outputHtml');
    const copyCssBtn = document.getElementById('copyCss');
    const copyHtmlBtn = document.getElementById('copyHtml');
    const apiStatus = document.getElementById('apiStatus');

    const loading = document.getElementById('loading');

    let dataUrl = "";

    function setLoading(on) { loading.classList.toggle('on', !!on); }
    function setStatus(text) { apiStatus.textContent = text; }

    function setPreview(src) {
      dataUrl = src || "";
      preview.src = dataUrl || "";
      drop.classList.toggle('has-img', !!dataUrl);
      imgStatus.textContent = dataUrl ? "Image loaded" : "No image selected";
    }

    chooseBtn.addEventListener('click', () => fileInput.click());
    drop.querySelector('.change-overlay').addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', (e) => {
      const f = e.target.files?.[0];
      if (!f) return;
      const r = new FileReader();
      r.onload = () => setPreview(r.result);
      r.readAsDataURL(f);
    });

    ;['dragenter','dragover'].forEach(evt =>
      drop.addEventListener(evt, e => { e.preventDefault(); drop.classList.add('drag'); })
    );
    ;['dragleave','drop'].forEach(evt =>
      drop.addEventListener(evt, e => { e.preventDefault(); drop.classList.remove('drag'); })
    );
    drop.addEventListener('drop', (e) => {
      const f = e.dataTransfer.files?.[0];
      if (!f) return;
      const r = new FileReader();
      r.onload = () => setPreview(r.result);
      r.readAsDataURL(f);
    });

    pasteBtn.addEventListener('click', async () => {
      try {
        const items = await navigator.clipboard.read();
        for (const it of items) {
          const type = it.types.find(t => t.startsWith('image/'));
          if (type) {
            const blob = await it.getType(type);
            const fr = new FileReader();
            fr.onload = () => setPreview(fr.result);
            fr.readAsDataURL(blob);
            return;
          }
        }
        alert("No image on clipboard");
      } catch { alert("Clipboard not allowed here"); }
    });

    clearBtn.addEventListener('click', () => {
      setPreview("");
      outCss.textContent = "";
      outHtml.textContent = "";
      setStatus("—");
    });

    function formatCSS(css) {
      if (!css) return "";
      css = css.replace(/\s*{\s*/g, " {\n").replace(/;\s*/g, ";\n").replace(/\s*}\s*/g, "\n}\n").replace(/\n{2,}/g, "\n");
      const lines = css.trim().split("\n");
      let depth = 0; const out = [];
      for (let line of lines) {
        const trimmed = line.trim();
        if (trimmed === "}") depth = Math.max(0, depth - 1);
        out.push("  ".repeat(depth) + trimmed);
        if (trimmed.endsWith("{")) depth++;
      }
      return out.join("\n").trim();
    }

    function formatHTML(html) {
      if (!html) return "";
      const tokens = html.replace(/></g, ">\n<").split("\n").map(s => s.trim()).filter(Boolean);
      const out = []; let depth = 0;
      const voids = new Set(["area","base","br","col","embed","hr","img","input","link","meta","param","source","track","wbr"]);
      for (let t of tokens) {
        const isClose = /^<\//.test(t);
        const isOpen = /^<[^/!][^>]*?>$/.test(t) && !/\/>$/.test(t);
        const tagMatch = t.match(/^<\/?([a-zA-Z0-9-]+)/);
        const tag = tagMatch ? tagMatch[1].toLowerCase() : null;
        if (isClose) depth = Math.max(0, depth - 1);
        out.push("  ".repeat(depth) + t);
        if (isOpen && tag && !voids.has(tag)) depth++;
      }
      return out.join("\n").trim();
    }

    document.getElementById('go').addEventListener('click', async () => {
      if (!dataUrl) { alert("Select or paste an image first"); return; }
      const scope = scopeEl.value.trim() || ".comp";
      const component = "";

      setLoading(true); setStatus("…");
      outCss.textContent = ""; outHtml.textContent = "";

      try {
        const r = await fetch("/api/generate-css", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ image: dataUrl, scope, component, double_checks: 1 })
        });

        const ok = r.ok;
        const payload = await r.json().catch(() => ({}));
        setStatus(`${r.status} ${ok ? "OK" : "Error"}`);

        if (!ok) {
          outCss.textContent = "/* Error — no CSS */";
          outHtml.textContent = "/* Error — no HTML */\n" + JSON.stringify(payload, null, 2);
          return;
        }

        outCss.textContent = formatCSS(payload.css || "") || "/* No CSS returned */";
        outHtml.textContent = formatHTML(payload.html || "") || "/* No HTML returned */";
      } catch (e) {
        setStatus("Fetch error");
        outCss.textContent = "/* Network error */";
        outHtml.textContent = String(e || "Unknown error");
      } finally {
        setLoading(false);
      }
    });

    copyCssBtn.addEventListener('click', async () => {
      const t = outCss.textContent || "";
      if (!t.trim()) return;
      try { await navigator.clipboard.writeText(t); copyCssBtn.textContent = "Copied!"; setTimeout(()=>copyCssBtn.textContent="Copy", 900); } catch {}
    });
    copyHtmlBtn.addEventListener('click', async () => {
      const t = outHtml.textContent || "";
      if (!t.trim()) return;
      try { await navigator.clipboard.writeText(t); copyHtmlBtn.textContent = "Copied!"; setTimeout(()=>copyHtmlBtn.textContent="Copy", 900); } catch {}
    });
  </script>
</body>
</html>
