<!-- Save as: app.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Generate CSS from Component Photo</title>
  <style>
    :root{
      --bg:#0b1020; --ink:#e2e8f0; --muted:#98a2b3; --border:#1f2a44; --accent:#7c95ff; --ok:#22c55e; --warn:#f59e0b; --err:#ef4444;
      --surface:#121933; --code:#0b122b;
      --radius:14px; --shadow:0 10px 30px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    body{margin:0; font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:var(--bg); color:var(--ink);}
    .wrap{max-width:1100px; margin:32px auto; padding:0 18px;}
    h1{margin:0 0 6px; font-size:28px; letter-spacing:-.02em}
    p.sub{margin:0 0 18px; color:var(--muted)}
    .grid{display:grid; grid-template-columns:420px 1fr; gap:18px}
    @media (max-width:1024px){ .grid{ grid-template-columns:1fr; } }

    .card{background:var(--surface); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); overflow:hidden}
    .head{display:flex; align-items:center; justify-content:space-between; padding:12px 14px; border-bottom:1px solid var(--border); background:linear-gradient(#121933,#0f162f)}
    .body{padding:12px}
    .row{display:flex; gap:10px; flex-wrap:wrap}
    .field{flex:1 1 180px}
    .label{display:block; font-weight:700; color:var(--muted); margin:0 0 6px}
    input[type="text"], input[type="number"], textarea{
      width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--border);
      background:#0a1229; color:var(--ink); outline:none;
    }
    input:focus, textarea:focus{box-shadow:0 0 0 3px rgba(124,149,255,.18)}
    textarea.code{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; min-height:180px; background:var(--code); border-color:#203055}
    .btn{display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border-radius:12px; border:1px solid var(--border); background:#0e1733; color:#fff; cursor:pointer; font-weight:800}
    .btn.primary{background:var(--accent); border-color:var(--accent); color:#0b1020}
    .btn.ghost{background:transparent}
    .btn:disabled{opacity:.6; cursor:not-allowed}
    .status{display:flex; align-items:center; gap:8px; color:var(--muted); font-weight:700}
    .pill{display:inline-block; padding:3px 8px; border-radius:999px; border:1px solid var(--border); background:#0b122b; color:var(--muted); font-size:12px}
    .ok{color:var(--ok)} .err{color:var(--err)} .warn{color:var(--warn)}

    .drop{
      border:2px dashed #2a3866; background:#0b122b; border-radius:12px; padding:14px; text-align:center; color:#cbd5e1;
    }
    .drop.drag{border-color:var(--accent); background:#0e1533}
    .preview{margin-top:10px; display:grid; grid-template-columns:1fr; gap:10px}
    .preview img{width:100%; max-height:360px; object-fit:contain; background:#000; border-radius:10px; border:1px solid #1e2b50}
    .rowBtns{display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-top:10px}
    .log{white-space:pre-wrap; background:#0b122b; border:1px solid #203055; border-radius:10px; padding:10px; color:#cbd5e1; max-height:200px; overflow:auto; font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}

    details > summary{cursor:pointer; color:var(--muted); font-weight:800; margin:10px 0 6px}
    .two{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    @media (max-width:900px){ .two{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Generate CSS from a Component Photo</h1>
    <p class="sub">Upload/paste a cropped screenshot of a <strong>single UI component</strong> (e.g., button/card/input). The server uses GPT-5 to draft CSS, then runs critique→fix loops.</p>

    <div class="grid">
      <!-- LEFT: image + params -->
      <section class="card">
        <div class="head">
          <div class="status"><span id="state">Idle</span></div>
          <div>
            <span class="pill" id="sizePill">0 KB</span>
          </div>
        </div>
        <div class="body">
          <div id="drop" class="drop">
            <b>Drop an image</b> (or click to pick). You can also paste (Ctrl/Cmd+V).
            <input id="file" type="file" accept="image/*" hidden>
          </div>
          <div class="preview"><img id="img" alt="preview" /></div>

          <div class="row" style="margin-top:12px">
            <div class="field"><label class="label" for="scope">Scope class</label>
              <input id="scope" type="text" value=".comp" placeholder=".comp">
            </div>
            <div class="field"><label class="label" for="component">Component hint</label>
              <input id="component" type="text" value="button" placeholder="button, card, input, ...">
            </div>
            <div class="field"><label class="label" for="checks">Double-check cycles (1–8)</label>
              <input id="checks" type="number" min="1" max="8" value="4">
            </div>
          </div>

          <div class="field" style="margin-top:10px">
            <label class="label" for="palette">Optional palette tokens (comma-separated)</label>
            <input id="palette" type="text" placeholder="--blue: #3b82f6, --radius: 12px">
          </div>

          <div class="rowBtns">
            <button id="run" class="btn primary">Generate CSS</button>
            <button id="copyCss" class="btn">Copy final CSS</button>
            <button id="copyDraft" class="btn ghost">Copy draft</button>
            <button id="clear" class="btn ghost">Clear</button>
            <span id="hint" class="muted"></span>
          </div>
        </div>
      </section>

      <!-- RIGHT: results -->
      <section class="card">
        <div class="head">
          <div class="status">Results</div>
          <div class="status">API: <span id="apiStatus" class="pill">–</span></div>
        </div>
        <div class="body">
          <div class="two">
            <div>
              <label class="label" for="draft">Draft (first pass)</label>
              <textarea id="draft" class="code" readonly></textarea>
            </div>
            <div>
              <label class="label" for="css">Final CSS</label>
              <textarea id="css" class="code" readonly></textarea>
            </div>
          </div>

          <details>
            <summary>Critique notes</summary>
            <div id="notes" class="log"></div>
          </details>

          <details>
            <summary>All versions</summary>
            <div id="versions" class="log"></div>
          </details>

          <details>
            <summary>API response / errors</summary>
            <div id="errors" class="log"></div>
          </details>
        </div>
      </section>
    </div>
  </div>

  <script>
    const el = (id)=>document.getElementById(id);

    const drop = el('drop');
    const file = el('file');
    const img = el('img');
    const sizePill = el('sizePill');
    const scope = el('scope');
    const component = el('component');
    const checks = el('checks');
    const palette = el('palette');

    const runBtn = el('run');
    const copyCssBtn = el('copyCss');
    const copyDraftBtn = el('copyDraft');
    const clearBtn = el('clear');

    const state = el('state');
    const apiStatus = el('apiStatus');
    const draftOut = el('draft');
    const cssOut = el('css');
    const notesOut = el('notes');
    const versionsOut = el('versions');
    const errorsOut = el('errors');

    let dataUrl = "";
    let lastResponse = null;

    // --- Drag & drop / click-to-pick / paste ---
    drop.addEventListener('click', ()=> file.click());
    drop.addEventListener('dragover', (e)=>{ e.preventDefault(); drop.classList.add('drag'); });
    drop.addEventListener('dragleave', ()=> drop.classList.remove('drag'));
    drop.addEventListener('drop', (e)=>{
      e.preventDefault();
      drop.classList.remove('drag');
      const f = e.dataTransfer.files?.[0];
      if (f) readFile(f);
    });
    file.addEventListener('change', (e)=>{
      const f = e.target.files?.[0];
      if (f) readFile(f);
    });
    window.addEventListener('paste', (e)=>{
      const item = [...(e.clipboardData?.items || [])].find(i => i.type.startsWith('image/'));
      if (item) readFile(item.getAsFile());
    });

    function readFile(f){
      const r = new FileReader();
      r.onload = () => {
        dataUrl = r.result;
        img.src = dataUrl;
        const bytes = f.size || (new Blob([dataUrl]).size);
        sizePill.textContent = formatBytes(bytes);
        state.textContent = "Image ready";
      };
      r.readAsDataURL(f);
    }

    function formatBytes(n){
      if (!n && n !== 0) return "0 KB";
      const u=['B','KB','MB','GB']; let i=0; while(n>=1024 && i<u.length-1){n/=1024;i++} return `${n.toFixed( (i===0)?0:1)} ${u[i]}`;
    }

    // --- Core fetch (WHOLE updated code you asked for) ---
    async function generateCSS({ image, palette = [], scope = ".comp", component = "button", double_checks = 4 }) {
      const r = await fetch("/api/generate-css", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ image, palette, scope, component, double_checks }),
      });

      // Surface real error details from the API
      if (!r.ok) {
        const payload = await safeJson(r);
        const msg = payload?.error || `HTTP ${r.status}`;
        console.error("API error:", payload);
        throw Object.assign(new Error(msg), { payload, status: r.status });
      }
      return r.json();
    }

    async function safeJson(r) {
      try { return await r.json(); } catch { return null; }
    }

    // --- UI actions ---
    runBtn.addEventListener('click', async ()=>{
      clearOutputs(false);

      if (!dataUrl || !dataUrl.startsWith("data:image")) {
        errorsOut.textContent = "Pick or paste an image first (cropped to a single component).";
        state.textContent = "No image"; apiStatus.textContent = "400"; apiStatus.style.color = "var(--warn)";
        return;
      }

      // Optional: parse palette tokens "a: x, b: y" → ["a: x","b: y"]
      const pal = palette.value
        ? palette.value.split(",").map(s => s.trim()).filter(Boolean)
        : [];

      try {
        state.textContent = "Generating…";
        runBtn.disabled = true;

        const res = await generateCSS({
          image: dataUrl,
          palette: pal,
          scope: scope.value || ".comp",
          component: component.value || "component",
          double_checks: Math.max(1, Math.min(8, Number(checks.value) || 4))
        });

        lastResponse = res;
        apiStatus.textContent = "200 OK"; apiStatus.style.color = "var(--ok)";
        state.textContent = `Done (${res.passes} passes)`;

        draftOut.value = res.draft || "";
        cssOut.value = res.css || "";
        notesOut.textContent = res.notes || "";

        // show versions (latest last)
        const versions = (res.versions || []).map((v,i)=>`v${i}: \n${v}`).join("\n\n---\n\n");
        versionsOut.textContent = versions || "(none)";
      } catch (err) {
        apiStatus.textContent = String(err.status || 500);
        apiStatus.style.color = "var(--err)";
        state.textContent = "Error";
        const payload = err.payload || {};
        errorsOut.textContent = [
          `Message: ${err.message || "(unknown)"}`,
          payload.error ? `Error: ${payload.error}` : "",
          payload.details ? `Details: ${stringify(payload.details)}` : "",
        ].filter(Boolean).join("\n");
      } finally {
        runBtn.disabled = false;
      }
    });

    copyCssBtn.addEventListener('click', async ()=>{
      if (!cssOut.value) return;
      try { await navigator.clipboard.writeText(cssOut.value); toast("Copied final CSS"); } catch {}
    });
    copyDraftBtn.addEventListener('click', async ()=>{
      if (!draftOut.value) return;
      try { await navigator.clipboard.writeText(draftOut.value); toast("Copied draft CSS"); } catch {}
    });
    clearBtn.addEventListener('click', ()=> clearAll());

    function clearOutputs(clearErrors=true){
      if (clearErrors) errorsOut.textContent = "";
      draftOut.value = ""; cssOut.value = ""; notesOut.textContent = ""; versionsOut.textContent = "";
      apiStatus.textContent = "–"; apiStatus.style.color = "";
    }
    function clearAll(){
      clearOutputs(true);
      dataUrl = ""; img.src = ""; sizePill.textContent = "0 KB"; state.textContent = "Idle";
      file.value = ""; palette.value = ""; scope.value = ".comp"; component.value = "button"; checks.value = 4;
    }
    function stringify(x){
      try { return JSON.stringify(x, null, 2); } catch { return String(x); }
    }
    function toast(msg){
      const t = document.createElement('div');
      t.textContent = msg;
      Object.assign(t.style, {
        position:'fixed', right:'14px', bottom:'14px', padding:'10px 12px', background:'#0e1733',
        color:'#fff', border:'1px solid #2a3866', borderRadius:'10px', zIndex:9999
      });
      document.body.appendChild(t);
      setTimeout(()=> t.remove(), 1200);
    }
  </script>
</body>
</html>
