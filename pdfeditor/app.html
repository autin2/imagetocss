<!-- app.html -->
<!DOCTYPE html>
<html lang="en" class="is-app">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Image → CSS</title>
  <link rel="stylesheet" href="style.css"/>

  <style>
    /* App-only polish layered on top of style.css */

    .wrap { max-width: var(--maxw); margin: 18px auto; padding: 0 20px; }

    .panel { background: var(--paper); border:1px solid var(--border); border-radius: var(--radius); box-shadow: var(--shadow); }
    .panel.head { padding: 14px 16px; font-weight: 800; border-bottom: 1px solid var(--border); }
    .panel.body { padding: 14px 16px; }

    /* Upload/select image box — stable height, image inside */
    .select-box{
      position: relative;
      border: 2px dashed var(--border);
      border-radius: 12px;
      min-height: 360px;              /* keep panel height stable */
      display: grid; place-items: center;
      background: #fff; overflow: hidden;
      cursor: pointer;
    }
    .select-inner { text-align:center; color:var(--muted); max-width:90%; }
    .select-inner .btn-row{ display:flex; gap:10px; justify-content:center; margin-top:10px; }
    .select-inner .hint{ margin-top:6px; font-size:13px; color:var(--muted); }

    .select-box.has-image{ border-style: solid; }
    .select-box img.preview{
      max-width:100%; max-height:100%;
      display:block; object-fit:contain;
    }

    /* Hover overlay appears only when an image exists */
    .change-overlay{
      position:absolute; inset:0;
      display:grid; place-items:center;
      background: rgba(2,6,23,0);
      transition: background .18s ease, opacity .18s ease;
      opacity:0; pointer-events:none;
    }
    .select-box.has-image:hover .change-overlay{
      background: rgba(2,6,23,.35);
      opacity:1; pointer-events:auto;
    }
    .change-overlay .btn{
      background:#fff; color:var(--ink); border-color:transparent; font-weight:800;
    }

    /* Controls row */
    .controls{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; margin-top:12px; }
    @media (max-width: 900px){ .controls{ grid-template-columns: 1fr 1fr; } }
    @media (max-width: 640px){ .controls{ grid-template-columns: 1fr; } }

    .ctrl{ display:flex; flex-direction:column; gap:6px; }
    .ctrl label{ font-size:12px; color:var(--muted); font-weight:700; }
    .ctrl input, .ctrl select{
      padding:10px 12px; border:1px solid var(--border); border-radius:10px; background:#fff; outline:none;
    }
    .ctrl input:focus, .ctrl select:focus{
      box-shadow:0 0 0 3px rgba(14,165,233,.18); border-color:#bae6fd;
    }

    .flat-row{ display:flex; align-items:center; gap:10px; margin-top:8px; }
    .flat-row label{ font-size:13px; color:var(--muted); }

    /* Action buttons */
    .actions{ display:flex; gap:10px; margin-top:12px; flex-wrap:wrap; }
    .actions .btn.primary{ background:var(--ink); color:#fff; border-color:transparent; }
    .actions .btn:disabled{ opacity:.6; cursor:not-allowed; }

    /* Right side panels: fixed heights to avoid growth reflow */
    .code#output{ height: 280px; }

    .copy-row{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:8px; }
    .copy-row .label{ color:var(--muted); font-size:13px; }
    .copy{ appearance:none; border:1px solid var(--border); background:#fff; color:var(--ink);
           padding:8px 10px; border-radius:10px; font-weight:700; cursor:pointer; }

    /* Status pill */
    .status-pill{ font-size:12px; padding:4px 8px; border-radius:999px; font-weight:800; }
    .ok{ background:#e6fffa; color:#065f46; border:1px solid #99f6e4; }
    .bad{ background:#fef2f2; color:#7f1d1d; border:1px solid #fecaca; }

    /* Loading scrim */
    .scrim{ position:fixed; inset:0; display:none; place-items:center; background:rgba(15,23,42,.35); z-index:2000; }
    .scrim.show{ display:grid; }
    .spinner{ width:42px; height:42px; border-radius:999px; border:3px solid rgba(255,255,255,.35); border-top-color:#fff; animation:spin .8s linear infinite; }
    @keyframes spin{ to{ transform:rotate(360deg); } }

    /* Prevent accidental text selection on buttons */
    .btn, .copy{ user-select:none; }
  </style>
</head>
<body class="is-app">
  <header class="header">
    <div class="container nav">
      <a class="brand" href="./">
        <div class="brand-mark"></div><b>Image → CSS</b>
      </a>
      <nav class="links">
        <a href="./">Home</a>
        <a href="#" aria-disabled="true">Docs</a>
      </nav>
    </div>
  </header>

  <main class="wrap">
    <div class="grid-2">
      <!-- LEFT: image + controls -->
      <section class="panel">
        <div class="panel head">Upload / Paste a Component Screenshot</div>
        <div class="panel body">
          <div id="selectBox" class="select-box" tabindex="0">
            <div id="selectInner" class="select-inner">
              <h3 style="margin:0 0 6px;">Drop an image, click <b>Choose</b>, or paste (Ctrl/Cmd+V).</h3>
              <div class="btn-row">
                <button id="chooseBtn" class="btn">Choose</button>
                <button id="pasteBtn" class="btn">Paste</button>
              </div>
              <div class="hint">Upload a tightly cropped screenshot of one component (button, card, input).</div>
            </div>
            <div class="change-overlay" id="changeOverlay" aria-hidden="true">
              <button id="changeBtn" class="btn">Change photo</button>
            </div>
            <input id="fileInput" type="file" accept="image/*" hidden />
          </div>

          <div class="controls">
            <div class="ctrl">
              <label for="scope">Scope class</label>
              <input id="scope" type="text" value=".comp" spellcheck="false" />
            </div>
            <div class="ctrl">
              <label for="component">Component hint</label>
              <input id="component" type="text" value="button" placeholder="button, card, input…" />
            </div>
            <div class="ctrl">
              <label for="checks">Checks (1–4)</label>
              <input id="checks" type="number" min="1" max="4" value="1" />
            </div>
          </div>

          <div class="flat-row">
            <label><input id="flatToggle" type="checkbox" /> Treat as flat (no gradients)</label>
            <label>Color: <input id="flatColor" type="text" placeholder="#3b82f6 (optional)" style="width:140px"/></label>
          </div>

          <div class="actions">
            <button id="goBtn" class="btn primary">Generate CSS</button>
            <button id="clearBtn" class="btn">Clear</button>
            <span id="apiPill" class="status-pill" style="display:none"></span>
          </div>
        </div>
      </section>

      <!-- RIGHT: outputs -->
      <section class="panel">
        <div class="panel head">Results</div>
        <div class="panel body">
          <div class="copy-row">
            <div class="label">Finished CSS</div>
            <button id="copyBtn" class="copy">Copy</button>
          </div>
          <pre id="output" class="code">/* Your CSS will appear here */</pre>

          <div class="copy-row" style="margin-top:14px;">
            <div class="label">API Errors</div>
          </div>
          <div style="display:flex; align-items:center; gap:10px; margin-bottom:6px;">
            <div id="apiLine" class="label">API: –</div>
          </div>
          <pre id="apiErrors" class="code">— none —</pre>
        </div>
      </section>
    </div>
  </main>

  <div id="scrim" class="scrim" aria-hidden="true"><div class="spinner"></div></div>

  <script>
    // Elements
    const selectBox = document.getElementById('selectBox');
    const selectInner = document.getElementById('selectInner');
    const changeOverlay = document.getElementById('changeOverlay');
    const chooseBtn = document.getElementById('chooseBtn');
    const pasteBtn = document.getElementById('pasteBtn');
    const changeBtn = document.getElementById('changeBtn');
    const fileInput = document.getElementById('fileInput');

    const scopeEl = document.getElementById('scope');
    const compEl = document.getElementById('component');
    const checksEl = document.getElementById('checks');
    const flatToggleEl = document.getElementById('flatToggle');
    const flatColorEl = document.getElementById('flatColor');

    const goBtn = document.getElementById('goBtn');
    const clearBtn = document.getElementById('clearBtn');

    const outputEl = document.getElementById('output');
    const copyBtn = document.getElementById('copyBtn');
    const apiLine = document.getElementById('apiLine');
    const apiPill = document.getElementById('apiPill');
    const apiErrorsEl = document.getElementById('apiErrors');

    const scrim = document.getElementById('scrim');

    // State
    let dataUrl = "";
    let previewImg = null;

    // Helpers
    function showScrim(on){ scrim.classList.toggle('show', !!on); }
    function setStatus(ok, text){
      apiPill.style.display = 'inline-block';
      apiPill.textContent = text || (ok ? 'OK' : 'Error');
      apiPill.className = 'status-pill ' + (ok ? 'ok' : 'bad');
    }
    function resetStatus(){
      apiPill.style.display = 'none';
      apiLine.textContent = 'API: –';
      apiErrorsEl.textContent = '— none —';
    }
    function toDataUrl(fileOrBlob){
      return new Promise((resolve, reject) => {
        const r = new FileReader();
        r.onload = () => resolve(r.result);
        r.onerror = reject;
        r.readAsDataURL(fileOrBlob);
      });
    }
    function setImage(src){
      dataUrl = src || "";
      // remove previous preview
      if (previewImg && previewImg.parentNode) previewImg.parentNode.removeChild(previewImg);
      previewImg = null;

      if (dataUrl){
        previewImg = document.createElement('img');
        previewImg.className = 'preview';
        previewImg.alt = 'Preview';
        previewImg.src = dataUrl;
        selectBox.appendChild(previewImg);
        selectBox.classList.add('has-image');
        changeOverlay.setAttribute('aria-hidden', 'false');
        selectInner.style.display = 'none';
      } else {
        selectBox.classList.remove('has-image');
        changeOverlay.setAttribute('aria-hidden', 'true');
        selectInner.style.display = '';
      }
    }

    // File choose
    chooseBtn.addEventListener('click', (e) => {
      e.preventDefault();
      fileInput.click();
    });
    changeBtn.addEventListener('click', (e) => {
      e.preventDefault();
      fileInput.click();
    });
    // If image present, clicking the box also opens chooser (but not overlay button)
    selectBox.addEventListener('click', (e) => {
      if (selectBox.classList.contains('has-image') && !e.target.closest('.change-overlay')){
        fileInput.click();
      }
    });

    fileInput.addEventListener('change', async (e) => {
      const f = e.target.files && e.target.files[0];
      if (!f) return;
      const du = await toDataUrl(f);
      setImage(du);
      resetStatus();
    });

    // Drag & drop
    ;['dragenter','dragover','dragleave','drop'].forEach(ev => {
      selectBox.addEventListener(ev, (e) => { e.preventDefault(); e.stopPropagation(); }, false);
    });
    selectBox.addEventListener('drop', async (e) => {
      const f = e.dataTransfer.files && e.dataTransfer.files[0];
      if (!f) return;
      const du = await toDataUrl(f);
      setImage(du);
      resetStatus();
    });

    // Paste button and global paste
    pasteBtn.addEventListener('click', async (e) => {
      e.preventDefault();
      try {
        if (navigator.clipboard && navigator.clipboard.read){
          const items = await navigator.clipboard.read();
          for (const it of items){
            for (const type of it.types){
              if (type.startsWith('image/')){
                const blob = await it.getType(type);
                const du = await toDataUrl(blob);
                setImage(du);
                resetStatus();
                return;
              }
            }
          }
        }
        alert('No image in clipboard or your browser blocked clipboard read.');
      } catch {
        alert('Clipboard read failed. Try ⌘/Ctrl+V directly.');
      }
    });
    window.addEventListener('paste', async (e) => {
      const items = e.clipboardData && e.clipboardData.items;
      if (!items) return;
      for (const it of items){
        if (it.type && it.type.startsWith('image/')){
          const blob = it.getAsFile();
          const du = await toDataUrl(blob);
          setImage(du);
          resetStatus();
          break;
        }
      }
    });

    // Generate
    goBtn.addEventListener('click', async () => {
      if (!dataUrl){ alert('Please select an image first.'); return; }

      const payload = {
        image: dataUrl,
        scope: scopeEl.value || ".comp",
        component: compEl.value || "component",
        double_checks: Math.max(1, Math.min(4, Number(checksEl.value || 1))),
        force_solid: !!flatToggleEl.checked,
        solid_color: (flatColorEl.value || "").trim(),
        minify: false,
        debug: false   // <- no raw model dump
      };

      showScrim(true);
      goBtn.disabled = true;
      setStatus(true, 'Working…');
      apiLine.textContent = 'API: (requesting…)';
      apiErrorsEl.textContent = '— none —';

      try {
        const resp = await fetch('/api/generate-css', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const isOK = resp.ok;
        let data;
        try { data = await resp.json(); } catch { data = {}; }

        apiLine.textContent = `API: ${resp.status} ${isOK ? 'OK' : (data?.error || 'Error')}`;
        setStatus(isOK, isOK ? 'Done' : 'Error');

        if (isOK) {
          const css = data?.css && String(data.css).trim();
          outputEl.textContent = css || '/* No CSS returned */';
          apiErrorsEl.textContent = '— none —';
        } else {
          outputEl.textContent = '/* Error — no CSS */';
          const payload = {
            error: data?.error || 'Unknown',
            details: data?.details || undefined,
            extra: data?.extra || undefined
          };
          apiErrorsEl.textContent = JSON.stringify(payload, null, 2);
        }
      } catch (e) {
        setStatus(false, 'Network error');
        apiLine.textContent = 'API: request failed';
        outputEl.textContent = '/* Request failed — see errors pane */';
        apiErrorsEl.textContent = JSON.stringify({ error: String(e?.message || e || 'Unknown error') }, null, 2);
      } finally {
        showScrim(false);
        goBtn.disabled = false;
      }
    });

    // Copy CSS
    copyBtn.addEventListener('click', async () => {
      const txt = outputEl.textContent || '';
      if (!txt.trim()) return;
      try {
        await navigator.clipboard.writeText(txt);
        copyBtn.textContent = 'Copied!';
        setTimeout(() => copyBtn.textContent = 'Copy', 900);
      } catch {}
    });

    // Clear
    clearBtn.addEventListener('click', () => {
      setImage("");
      scopeEl.value = ".comp";
      compEl.value = "button";
      checksEl.value = "1";
      flatToggleEl.checked = false;
      flatColorEl.value = "";
      outputEl.textContent = '/* Your CSS will appear here */';
      resetStatus();
    });
  </script>
</body>
</html>
