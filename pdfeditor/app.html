<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Image → index.html</title>
  <link rel="stylesheet" href="style.css"/>
</head>
<body class="is-app">
  <header class="header">
    <div class="container nav">
      <a href="/" class="brand"><b>Image&nbsp;to&nbsp;CSS</b></a>
      <nav class="links">
        <a href="index.html">Home</a>
        <a href="pricing.html">Pricing</a>
      </nav>
    </div>
  </header>

  <main class="container" style="padding:28px 16px">
    <!-- Drop zone -->
    <section class="card pad" aria-labelledby="imgLabel">
      <h2 id="imgLabel" style="margin:0 0 10px">Image</h2>
      <div id="drop" class="snip-frame drop" role="button" tabindex="0" aria-label="Drag & drop or select an image">
        <div id="dropInner" class="drop-inner">
          <div>
            <strong>Drag & drop an image</strong> or click to select
            <div class="hint">JPG, PNG, or WebP · processed locally</div>
            <div class="btn-row"><button id="selectBtn" class="btn small" type="button">Select image</button></div>
          </div>
        </div>
        <input id="fileInput" class="hidden-input" type="file" accept="image/*" aria-label="Choose image"/>
      </div>
    </section>

    <!-- Index HTML output -->
    <section class="card pad" style="margin-top:14px" aria-labelledby="idxLabel">
      <div class="outputbar">
        <span id="idxLabel" class="label">index.html (copy / download)</span>
        <div>
          <button id="copyIndex" class="btn small" type="button">Copy</button>
          <button id="downloadIndex" class="btn small" type="button">Download</button>
        </div>
      </div>
      <pre id="indexOut" class="code" aria-live="polite"><!-- Generated index.html will appear here --></pre>
    </section>

    <!-- Live preview -->
    <section class="card pad" style="margin-top:14px" aria-labelledby="prevLabel">
      <div class="outputbar"><span id="prevLabel" class="label">Live preview</span></div>
      <iframe id="preview" title="index.html preview" style="width:100%;height:520px;border:1px solid var(--border-light,#e5e7eb);border-radius:8px"></iframe>
    </section>
  </main>

  <script>
    // Elements
    const drop = document.getElementById('drop');
    const dropInner = document.getElementById('dropInner');
    const fileInput = document.getElementById('fileInput');
    const selectBtn = document.getElementById('selectBtn');
    const indexOut = document.getElementById('indexOut');
    const copyIndex = document.getElementById('copyIndex');
    const downloadIndex = document.getElementById('downloadIndex');
    const preview = document.getElementById('preview');

    // Click/select
    selectBtn.addEventListener('click', () => fileInput.click());
    drop.addEventListener('click', () => fileInput.click());
    drop.addEventListener('keydown', e => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); fileInput.click(); } });

    // Drag & drop
    ['dragenter','dragover'].forEach(ev => drop.addEventListener(ev, e => { e.preventDefault(); drop.classList.add('drag'); }));
    ['dragleave','drop'].forEach(ev => drop.addEventListener(ev, e => { e.preventDefault(); drop.classList.remove('drag'); }));
    drop.addEventListener('drop', e => { const f = e.dataTransfer.files?.[0]; if (f) handleFile(f); });
    fileInput.addEventListener('change', e => { const f = e.target.files?.[0]; if (f) handleFile(f); });

    // Canvas downscale → data URI
    function toDataUri(img, maxSide = 1600){
      const ratio = Math.min(maxSide / img.width, maxSide / img.height, 1);
      const w = Math.max(1, Math.round(img.width * ratio));
      const h = Math.max(1, Math.round(img.height * ratio));
      const c = document.createElement('canvas');
      c.width = w; c.height = h;
      const cx = c.getContext('2d', { willReadFrequently: true });
      cx.drawImage(img, 0, 0, w, h);
      return c.toDataURL('image/png', 0.92);
    }

    // Quick palette sampler (optional hint; neutral)
    function extractPalette(dataUri){
      return []; // keep neutral; you can plug your sampler here if you still want to send a palette hint
    }

    async function handleFile(file){
      if (!file.type.startsWith('image/')) { alert('Please choose an image file.'); return; }

      const img = new Image();
      const url = URL.createObjectURL(file);
      img.onload = async () => {
        // preview thumbnail inside drop
        dropInner.innerHTML = '';
        const thumb = document.createElement('img');
        thumb.src = url; thumb.className = 'preview-img';
        dropInner.appendChild(thumb);

        const dataUri = toDataUri(img, 1600);
        const palette = extractPalette(dataUri); // currently []

        indexOut.textContent = '<!-- Generating full index.html... -->';
        preview.srcdoc = '<!doctype html><html><body style="font:14px system-ui, sans-serif;padding:16px;color:#666">Generating…</body></html>';

        try {
          const r = await fetch('/api/generate-index', {
            method: 'POST',
            headers: { 'content-type': 'application/json' },
            body: JSON.stringify({ image: dataUri, palette, passes: 5 })
          });
          const html = await r.text();
          if (!r.ok) throw new Error('API error');
          indexOut.textContent = html;
          preview.srcdoc = html;
        } catch (e) {
          console.error(e);
          indexOut.textContent = '<!-- Failed to generate index.html -->';
          preview.srcdoc = '<!doctype html><html><body style="font:14px system-ui, sans-serif;padding:16px;color:#c00">Failed.</body></html>';
        } finally {
          setTimeout(() => URL.revokeObjectURL(url), 1500);
        }
      };
      img.onerror = () => alert('Could not load that image.');
      img.src = url;
    }

    // Copy & Download
    copyIndex.addEventListener('click', async () => {
      try { await navigator.clipboard.writeText(indexOut.textContent); copyIndex.textContent='Copied!'; setTimeout(()=>copyIndex.textContent='Copy', 900); }
      catch { alert('Unable to copy.'); }
    });

    downloadIndex.addEventListener('click', () => {
      const blob = new Blob([indexOut.textContent], { type: 'text/html;charset=utf-8' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'index.html';
      document.body.appendChild(a);
      a.click();
      setTimeout(() => { URL.revokeObjectURL(a.href); a.remove(); }, 500);
    });
  </script>
</body>
</html>
