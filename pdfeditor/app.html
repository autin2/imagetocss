<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Image → CSS (Component-only)</title>
  <link rel="stylesheet" href="style.css"/>
  <meta name="description" content="Upload a cropped photo of a single UI component (button, card, input) and get scoped CSS generated by GPT-5 with critique→fix loops."/>
</head>
<body class="is-app">
  <!-- Header -->
  <header class="header">
    <div class="container">
      <nav class="nav">
        <a class="brand" href="/">
          <span class="brand-mark"></span>
          <b>Image → CSS</b>
        </a>
        <div class="links">
          <a href="#" aria-disabled="true">Docs</a>
          <a href="#" aria-disabled="true">Inspector</a>
          <a href="#" aria-current="page">App</a>
          <button id="runBtnTop" class="btn accent small">Generate</button>
        </div>
      </nav>
    </div>
  </header>

  <!-- Main -->
  <main class="container" style="margin:20px 0 18px">
    <section class="hero" style="align-items:flex-start">
      <div class="grid-2" style="width:100%">
        <!-- LEFT: Input / Image / Params -->
        <div class="card pad">
          <span class="kicker"><span class="k-dot"></span> Component-only · Scoped CSS</span>
          <h1>Turn a component photo into CSS</h1>
          <p class="lead">Upload/paste a <b>cropped screenshot of one component</b> (e.g., a button, card, or input). We’ll generate CSS under your scope class and refine it with critique→fix loops.</p>

          <!-- Drop zone -->
          <div id="drop" class="snip-frame drop" style="margin-top:10px">
            <div class="drop-inner">
              <div>
                <b>Drop an image here</b> or click <em>Choose</em>. You can also paste (Ctrl/Cmd+V).
                <div class="btn-row" style="margin-top:10px">
                  <button id="chooseBtn" class="btn">Choose image</button>
                  <button id="pasteBtn" class="btn">Paste</button>
                </div>
                <div class="hint" id="sizeHint">No image selected</div>
              </div>
              <input id="file" type="file" accept="image/*" hidden>
            </div>
          </div>

          <!-- Preview -->
          <img id="preview" class="preview-img" alt="Preview" style="margin-top:10px;display:none"/>

          <!-- Params -->
          <div class="grid-3" style="margin-top:12px">
            <div>
              <label for="scope" class="label">Scope class</label>
              <input id="scope" type="text" value=".comp" placeholder=".comp">
            </div>
            <div>
              <label for="component" class="label">Component hint</label>
              <input id="component" type="text" value="button" placeholder="button, card, input, …">
            </div>
            <div>
              <label for="checks" class="label">Double-checks (1–8)</label>
              <input id="checks" type="number" min="1" max="8" value="4">
            </div>
          </div>

          <div style="margin-top:10px">
            <label for="palette" class="label">Optional palette tokens (comma-separated)</label>
            <input id="palette" type="text" placeholder="--blue: #3b82f6, --radius: 12px">
          </div>

          <div style="display:flex;gap:10px;align-items:center;margin-top:12px">
            <button id="runBtn" class="btn primary">Generate CSS</button>
            <button id="clearBtn" class="btn">Clear</button>
            <span class="lead" id="statusLead" style="margin:0;font-size:13px"></span>
          </div>

          <!-- Demo component (reflects palette tokens via CSS vars) -->
          <div class="hero-visual" style="margin-top:14px">
            <div class="demo-card token-card">
              <div class="demo-avatar">UI</div>
              <div>
                <p class="demo-title">Component Preview</p>
                <p class="demo-sub">Palette variables will tint this demo</p>
                <div class="demo-tags">
                  <span class="demo-tag">scoped</span>
                  <span class="demo-tag">:hover</span>
                  <span class="demo-tag">tokens</span>
                </div>
              </div>
              <div class="demo-cta">
                <button class="btn">Try it</button>
              </div>
            </div>
          </div>
        </div>

        <!-- RIGHT: Output -->
        <div class="card pad">
          <div class="outputbar">
            <span class="label">Final CSS</span>
            <div style="display:flex;gap:8px">
              <button id="copyFinalBtn" class="btn small">Copy</button>
            </div>
          </div>
          <pre id="output" class="code" aria-label="Final CSS"></pre>

          <div class="outputbar" style="margin-top:12px">
            <span class="label">Draft (first pass)</span>
            <div style="display:flex;gap:8px">
              <button id="copyDraftBtn" class="btn small">Copy</button>
            </div>
          </div>
          <pre id="draft" class="code" aria-label="Draft CSS"></pre>

          <div class="grid-2" style="margin-top:12px">
            <div>
              <div class="outputbar"><span class="label">Critique notes</span></div>
              <pre id="notes" class="code" style="height:180px"></pre>
            </div>
            <div>
              <div class="outputbar"><span class="label">All versions</span></div>
              <pre id="versions" class="code" style="height:180px"></pre>
            </div>
          </div>

          <div style="margin-top:12px">
            <div class="outputbar"><span class="label">API response / errors</span></div>
            <pre id="errors" class="code" style="height:140px"></pre>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Footer -->
  <footer class="footer">
    <div class="container" style="display:flex;justify-content:space-between;align-items:center">
      <span>© Image → CSS</span>
      <span id="apiBadge" class="kicker" style="border:none;background:#eef6ff;color:#1f2937">
        API: <b id="apiStatus" style="margin-left:6px">—</b>
      </span>
    </div>
  </footer>

  <script>
    // ------- Elements -------
    const fileEl = document.getElementById('file');
    const dropEl = document.getElementById('drop');
    const chooseBtn = document.getElementById('chooseBtn');
    const pasteBtn = document.getElementById('pasteBtn');
    const sizeHint = document.getElementById('sizeHint');
    const preview = document.getElementById('preview');

    const scopeEl = document.getElementById('scope');
    const componentEl = document.getElementById('component');
    const checksEl = document.getElementById('checks');
    const paletteEl = document.getElementById('palette');

    const runBtn = document.getElementById('runBtn');
    const runBtnTop = document.getElementById('runBtnTop');
    const clearBtn = document.getElementById('clearBtn');

    const statusLead = document.getElementById('statusLead');
    const apiStatus = document.getElementById('apiStatus');

    const outputEl = document.getElementById('output');
    const draftEl = document.getElementById('draft');
    const notesEl = document.getElementById('notes');
    const versionsEl = document.getElementById('versions');
    const errorsEl = document.getElementById('errors');

    const copyFinalBtn = document.getElementById('copyFinalBtn');
    const copyDraftBtn = document.getElementById('copyDraftBtn');

    let dataUrl = "";

    // ------- Drag & Drop / Choose / Paste -------
    chooseBtn.addEventListener('click', () => fileEl.click());
    pasteBtn.addEventListener('click', () => {
      navigator.clipboard.read && navigator.clipboard.read().then(async items => {
        for (const item of items) {
          for (const type of item.types) {
            if (type.startsWith('image/')) {
              const blob = await item.getType(type);
              readFile(blob);
              return;
            }
          }
        }
        flashHint("No image on clipboard");
      }).catch(()=> flashHint("Clipboard read not allowed"));
    });

    fileEl.addEventListener('change', (e) => {
      const f = e.target.files?.[0];
      if (f) readFile(f);
    });

    dropEl.addEventListener('dragover', (e) => { e.preventDefault(); dropEl.classList.add('drag'); });
    dropEl.addEventListener('dragleave', () => dropEl.classList.remove('drag'));
    dropEl.addEventListener('drop', (e) => {
      e.preventDefault();
      dropEl.classList.remove('drag');
      const f = e.dataTransfer.files?.[0];
      if (f) readFile(f);
    });

    window.addEventListener('paste', (e) => {
      const item = [...(e.clipboardData?.items || [])].find(i => i.type.startsWith('image/'));
      if (item) readFile(item.getAsFile());
    });

    function readFile(file) {
      const r = new FileReader();
      r.onload = () => {
        dataUrl = r.result;
        preview.src = dataUrl;
        preview.style.display = 'block';
        sizeHint.textContent = formatBytes(file.size || new Blob([dataUrl]).size);
        statusLead.textContent = "Image ready";
      };
      r.readAsDataURL(file);
    }

    function formatBytes(n){
      if (!n && n !== 0) return "0 KB";
      const u=['B','KB','MB','GB']; let i=0; while(n>=1024 && i<u.length-1){n/=1024;i++} return `${n.toFixed( (i===0)?0:1)} ${u[i]}`;
    }
    function flashHint(msg){
      sizeHint.textContent = msg;
      setTimeout(()=> sizeHint.textContent = sizeHint.textContent || msg, 1500);
    }

    // ------- API helper -------
    async function generateCSS({ image, palette = [], scope = ".comp", component = "button", double_checks = 4 }) {
      const r = await fetch("/api/generate-css", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ image, palette, scope, component, double_checks }),
      });
      if (!r.ok) {
        let payload = null;
        try { payload = await r.json(); } catch {}
        const msg = (payload && payload.error) ? payload.error : `HTTP ${r.status}`;
        const err = new Error(msg);
        err.status = r.status;
        err.payload = payload;
        throw err;
      }
      return r.json();
    }

    // ------- Actions -------
    runBtn.addEventListener('click', onRun);
    runBtnTop.addEventListener('click', onRun);
    clearBtn.addEventListener('click', clearAll);

    async function onRun(){
      clearOutputs();
      if (!dataUrl || !dataUrl.startsWith('data:image')) {
        errorsEl.textContent = "Pick or paste an image first (cropped to a single component).";
        apiStatus.textContent = "400";
        statusLead.textContent = "No image";
        return;
      }
      const pal = paletteEl.value
        ? paletteEl.value.split(",").map(s => s.trim()).filter(Boolean)
        : [];

      try {
        runBtn.disabled = true; runBtnTop.disabled = true;
        statusLead.textContent = "Generating…";
        apiStatus.textContent = "…";

        const res = await generateCSS({
          image: dataUrl,
          palette: pal,
          scope: scopeEl.value || ".comp",
          component: componentEl.value || "component",
          double_checks: Math.max(1, Math.min(8, Number(checksEl.value) || 4))
        });

        apiStatus.textContent = "200 OK";
        statusLead.textContent = `Done (${res.passes} passes)`;

        draftEl.textContent = res.draft || "";
        outputEl.textContent = res.css || "";
        notesEl.textContent = res.notes || "";

        const versions = (res.versions || []).map((v,i)=>`v${i}:\n${v}`).join("\n\n---\n\n");
        versionsEl.textContent = versions || "(none)";
      } catch (err) {
        apiStatus.textContent = String(err.status || 500);
        statusLead.textContent = "Error";
        errorsEl.textContent = [
          `Message: ${err.message || "(unknown)"}`,
          err.payload?.error ? `Error: ${err.payload.error}` : "",
          err.payload?.details ? `Details: ${safeString(err.payload.details)}` : "",
        ].filter(Boolean).join("\n");
      } finally {
        runBtn.disabled = false; runBtnTop.disabled = false;
      }
    }

    function clearOutputs(){
      outputEl.textContent = "";
      draftEl.textContent = "";
      notesEl.textContent = "";
      versionsEl.textContent = "";
      errorsEl.textContent = "";
      apiStatus.textContent = "—";
      statusLead.textContent = "";
    }
    function clearAll(){
      clearOutputs();
      dataUrl = "";
      preview.src = "";
      preview.style.display = "none";
      sizeHint.textContent = "No image selected";
      scopeEl.value = ".comp";
      componentEl.value = "button";
      checksEl.value = 4;
      paletteEl.value = "";
    }
    function safeString(x){ try { return JSON.stringify(x, null, 2); } catch { return String(x); } }

    // Small UX sugar: copy buttons
    copyFinalBtn.addEventListener('click', async ()=> {
      if (!outputEl.textContent) return;
      try { await navigator.clipboard.writeText(outputEl.textContent); flashCopy(copyFinalBtn); } catch {}
    });
    copyDraftBtn.addEventListener('click', async ()=> {
      if (!draftEl.textContent) return;
      try { await navigator.clipboard.writeText(draftEl.textContent); flashCopy(copyDraftBtn); } catch {}
    });
    function flashCopy(btn){
      const prev = btn.textContent;
      btn.textContent = "Copied!";
      setTimeout(()=> btn.textContent = prev, 900);
    }
  </script>
</body>
</html>
