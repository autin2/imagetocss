<!-- Save as: app.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Image → CSS (Component-only)</title>
  <style>
    :root{
      --bg:#f7f9fc; --ink:#0f172a; --muted:#64748b; --paper:#ffffff; --border:#e5e7eb;
      --accent:#0ea5e9; --accent-ink:#06222c; --ok:#16a34a; --err:#ef4444;
      --radius:14px; --shadow:0 8px 24px rgba(2,6,23,.06);
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.55 system-ui,-apple-system,"Segoe UI",Roboto,Arial}
    .wrap{max-width:1000px;margin:28px auto;padding:0 18px}
    h1{margin:0 0 6px;font-size:30px;letter-spacing:-.02em}
    .sub{margin:0 0 14px;color:var(--muted)}
    .grid{display:grid;grid-template-columns:1.05fr .95fr;gap:20px}
    @media (max-width:980px){ .grid{grid-template-columns:1fr} }

    .card{background:var(--paper);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow)}
    .pad{padding:16px}

    /* Inputs, buttons */
    label{display:block;font-weight:700;color:var(--muted);margin:10px 0 6px}
    input[type="text"], input[type="number"]{
      width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:#fff;outline:none
    }
    input[type="text"]:focus, input[type="number"]:focus{box-shadow:0 0 0 3px rgba(14,165,233,.18); border-color:#bfe6fb}
    .btn{appearance:none;border:1px solid var(--border);background:#fff;color:var(--ink);
      padding:10px 14px;border-radius:10px;font-weight:700;cursor:pointer}
    .btn.primary{background:var(--accent);color:var(--accent-ink);border-color:transparent}
    .btn.small{padding:8px 10px;font-size:13px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}

    /* Drop + preview */
    .drop{border:2px dashed var(--border);background:#fff;border-radius:12px;padding:14px;text-align:center;color:var(--muted)}
    .drop.drag{border-color:var(--accent);background:#f0fbff}
    #preview{display:none;margin-top:10px;max-width:100%;max-height:380px;border:1px solid var(--border);border-radius:10px}

    /* Code areas */
    .bar{display:flex;align-items:center;justify-content:space-between;margin:10px 0 6px}
    .bar .label{color:var(--muted);font-size:13px}
    pre.code{
      background:#0a0c10;color:#e5e7eb;font:13px/1.45 ui-monospace, Menlo, Consolas, monospace;
      border-radius:10px;border:1px solid #1f2937;padding:12px;overflow:auto;height:220px;white-space:pre
    }
    #errors{border-color:rgba(239,68,68,.35); color:#ffe1e1; background:#2a0b0b}

    .hint{color:var(--muted);font-size:13px}
    .pill{display:inline-block;padding:3px 8px;border-radius:999px;border:1px solid var(--border);background:#fff;font-size:12px}
    .ok{color:var(--ok)} .err{color:var(--err)}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Image → CSS</h1>
    <p class="sub">Upload/paste a <b>cropped screenshot of one component</b> (button, card, input). We’ll generate scoped CSS with GPT-5.</p>

    <div class="grid">
      <!-- LEFT -->
      <section class="card pad">
        <div class="drop" id="drop">
          <div><b>Drop an image</b>, click <em>Choose</em>, or paste (Ctrl/Cmd+V).</div>
          <div class="row" style="justify-content:center;margin-top:8px">
            <button id="chooseBtn" class="btn small">Choose</button>
            <button id="pasteBtn" class="btn small">Paste</button>
          </div>
          <div class="hint" id="sizeHint" style="margin-top:6px">No image selected</div>
          <input id="file" type="file" accept="image/*" hidden>
        </div>

        <img id="preview" alt="Preview"/>

        <div class="row" style="margin-top:12px">
          <div style="flex:1 1 220px">
            <label for="scope">Scope class</label>
            <input id="scope" type="text" value=".comp" placeholder=".comp">
          </div>
          <div style="flex:1 1 220px">
            <label for="component">Component hint</label>
            <input id="component" type="text" value="button" placeholder="button, card, input, …">
          </div>
          <div style="flex:1 1 100%">
            <label for="palette">Optional palette tokens (comma-separated)</label>
            <input id="palette" type="text" placeholder="--blue: #3b82f6, --radius: 12px">
          </div>
        </div>

        <div class="row" style="margin-top:12px">
          <button id="runBtn" class="btn primary">Generate CSS</button>
          <button id="clearBtn" class="btn">Clear</button>
          <span class="hint" id="statusLead"></span>
          <span class="pill">API: <b id="apiStatus">—</b></span>
        </div>
      </section>

      <!-- RIGHT -->
      <section class="card pad">
        <div class="bar">
          <span class="label">Final CSS</span>
          <button id="copyFinalBtn" class="btn small">Copy</button>
        </div>
        <pre id="output" class="code" aria-label="Final CSS"></pre>

        <div class="bar" style="margin-top:10px">
          <span class="label">Draft (first pass)</span>
          <button id="copyDraftBtn" class="btn small">Copy</button>
        </div>
        <pre id="draft" class="code" aria-label="Draft CSS"></pre>

        <div class="bar" style="margin-top:10px"><span class="label">Critique notes</span></div>
        <pre id="notes" class="code" style="height:160px"></pre>

        <div class="bar" style="margin-top:10px"><span class="label">All versions</span></div>
        <pre id="versions" class="code" style="height:160px"></pre>

        <div class="bar" style="margin-top:10px"><span class="label">API response / errors</span></div>
        <pre id="errors" class="code"></pre>
      </section>
    </div>
  </div>

  <script>
    // ----- Elements -----
    const fileEl = document.getElementById('file');
    const dropEl = document.getElementById('drop');
    const chooseBtn = document.getElementById('chooseBtn');
    const pasteBtn = document.getElementById('pasteBtn');
    const sizeHint = document.getElementById('sizeHint');
    const preview = document.getElementById('preview');

    const scopeEl = document.getElementById('scope');
    const componentEl = document.getElementById('component');
    const paletteEl = document.getElementById('palette');

    const runBtn = document.getElementById('runBtn');
    const clearBtn = document.getElementById('clearBtn');
    const statusLead = document.getElementById('statusLead');
    const apiStatus = document.getElementById('apiStatus');

    const outputEl = document.getElementById('output');
    const draftEl = document.getElementById('draft');
    const notesEl = document.getElementById('notes');
    const versionsEl = document.getElementById('versions');
    const errorsEl = document.getElementById('errors');

    const copyFinalBtn = document.getElementById('copyFinalBtn');
    const copyDraftBtn = document.getElementById('copyDraftBtn');

    let dataUrl = "";

    // ----- DnD / Choose / Paste -----
    chooseBtn.addEventListener('click', () => fileEl.click());
    fileEl.addEventListener('change', (e) => { const f = e.target.files?.[0]; if (f) readFile(f); });

    dropEl.addEventListener('dragover', (e)=>{ e.preventDefault(); dropEl.classList.add('drag'); });
    dropEl.addEventListener('dragleave', ()=> dropEl.classList.remove('drag'));
    dropEl.addEventListener('drop', (e)=>{
      e.preventDefault(); dropEl.classList.remove('drag');
      const f = e.dataTransfer.files?.[0]; if (f) readFile(f);
    });

    pasteBtn.addEventListener('click', () => {
      navigator.clipboard.read?.().then(async items => {
        for (const item of items) for (const t of item.types) {
          if (t.startsWith('image/')) { const blob = await item.getType(t); readFile(blob); return; }
        }
        flash("No image on clipboard");
      }).catch(()=> flash("Clipboard read not allowed"));
    });
    window.addEventListener('paste', (e) => {
      const it = [...(e.clipboardData?.items || [])].find(i => i.type.startsWith('image/'));
      if (it) readFile(it.getAsFile());
    });

    function readFile(file){
      const r = new FileReader();
      r.onload = () => {
        dataUrl = r.result;
        preview.src = dataUrl;
        preview.style.display = 'block';
        sizeHint.textContent = formatBytes(file.size || new Blob([dataUrl]).size);
        statusLead.textContent = "Image ready";
      };
      r.readAsDataURL(file);
    }

    function formatBytes(n){ if (!n && n!==0) return "0 KB"; const u=['B','KB','MB','GB']; let i=0; while(n>=1024 && i<u.length-1){n/=1024;i++} return `${n.toFixed(i?1:0)} ${u[i]}`; }
    function flash(msg){ sizeHint.textContent = msg; setTimeout(()=> sizeHint.textContent = sizeHint.textContent || msg, 1400); }

    // ----- API helper (safe text → JSON) -----
    async function generateCSS({ image, palette = [], scope = ".comp", component = "button" }) {
      const r = await fetch("/api/generate-css", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ image, palette, scope, component }), // single-pass API ignores checks
      });

      const text = await r.text(); // read raw
      let json = null;
      try { json = JSON.parse(text); } catch {}

      if (!r.ok) {
        const err = new Error(
          (json && (json.error || json.message)) || text || `HTTP ${r.status}`
        );
        err.status = r.status;
        err.payload = json ?? text;
        throw err;
      }

      return json ?? { error: "Malformed JSON from server", raw: text };
    }

    function fmt(x) {
      if (typeof x === "string") return x;
      try { return JSON.stringify(x, null, 2); } catch { return String(x); }
    }

    // ----- Actions -----
    runBtn.addEventListener('click', onRun);
    clearBtn.addEventListener('click', clearAll);
    copyFinalBtn.addEventListener('click', async ()=> { if (!outputEl.textContent) return; try { await navigator.clipboard.writeText(outputEl.textContent); copyFlash(copyFinalBtn); } catch {} });
    copyDraftBtn.addEventListener('click', async ()=> { if (!draftEl.textContent) return; try { await navigator.clipboard.writeText(draftEl.textContent); copyFlash(copyDraftBtn); } catch {} });

    async function onRun(){
      clearOutputs();
      if (!dataUrl || !dataUrl.startsWith('data:image')) {
        errorsEl.textContent = "Pick or paste an image first (cropped to a single component).";
        apiStatus.textContent = "400"; apiStatus.classList.add('err'); return;
      }
      const pal = paletteEl.value ? paletteEl.value.split(",").map(s => s.trim()).filter(Boolean) : [];

      try {
        runBtn.disabled = true;
        statusLead.textContent = "Generating…"; apiStatus.textContent = "…"; apiStatus.classList.remove('err','ok');

        const res = await generateCSS({
          image: dataUrl,
          palette: pal,
          scope: scopeEl.value || ".comp",
          component: componentEl.value || "component"
        });

        apiStatus.textContent = "200 OK"; apiStatus.classList.add('ok');
        statusLead.textContent = `Done (${res.passes} passes)`;

        draftEl.textContent = res.draft || "";
        outputEl.textContent = res.css || "";
        notesEl.textContent = res.notes || "";
        versionsEl.textContent = (res.versions || []).map((v,i)=>`v${i}:\n${v}`).join("\n\n---\n\n") || "(none)";

        // Show raw model text if CSS is empty to help debug extraction
        if (!res.css || !res.css.trim()) {
          errorsEl.textContent = `Model raw_out (first 2k):\n` + String(res.raw_out || "").slice(0, 2000);
        } else {
          errorsEl.textContent = ""; // clear any previous raw_out
        }
      } catch (err) {
        apiStatus.textContent = String(err.status || 500); apiStatus.classList.add('err');
        statusLead.textContent = "Error";
        const dump = [
          `Status: ${err.status ?? 'unknown'}`,
          `Message: ${fmt(err.message)}`,
          err.payload !== undefined ? `Payload:\n${fmt(err.payload)}` : ""
        ].filter(Boolean).join("\n");
        errorsEl.textContent = dump;
        console.error("API error dump:", err);
      } finally {
        runBtn.disabled = false;
      }
    }

    function clearOutputs(){
      outputEl.textContent = ""; draftEl.textContent = ""; notesEl.textContent = ""; versionsEl.textContent = ""; errorsEl.textContent = "";
      apiStatus.textContent = "—"; apiStatus.classList.remove('ok','err'); statusLead.textContent = "";
    }
    function clearAll(){
      clearOutputs(); dataUrl=""; preview.src=""; preview.style.display="none";
      sizeHint.textContent="No image selected"; scopeEl.value=".comp"; componentEl.value="button"; paletteEl.value="";
    }
    function copyFlash(btn){ const prev=btn.textContent; btn.textContent="Copied!"; setTimeout(()=>btn.textContent=prev, 900); }
  </script>
</body>
</html>
